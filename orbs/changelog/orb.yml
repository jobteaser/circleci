version: 2.1

description: |
  Create and announce changelogs for Git repositories.

executors:
  default:
    docker:
      - image: "ubuntu:18.04"

jobs:
  publish:
    parameters:
      environment:
        description: "The runtime environment."
        type: string
        default: "staging"
      slack_webhook_uri:
        description: "The Slack webhook URI."
        type: string
        default: "$SLACK_WEBHOOK_URI"
      icon_emoji:
        description: "The emoji to use as icon for messages."
        type: string
        default: ":poop:"
    executor: "default"
    steps:
      - run:
          name: "Install dependencies"
          command: |
            apt-get update -y
            apt-get install -y git openssh-client ca-certificates curl jq
            curl -sL https://deb.nodesource.com/setup_10.x | bash -
            apt-get install -y nodejs
      - checkout
      - run:
          name: "Publish the changelog"
          command: |
            # Note that we need to tag just before the last one since we just
            # tagged the new version.
            npx @jobteaser/slack-release-notes \
                --repo-url "https://github.com/jobteaser/$CIRCLE_PROJECT_REPONAME" \
                --tag-prefix "deployment-<<parameters.environment>>-" \
                --project-name "$CIRCLE_PROJECT_REPONAME" \
                --webhook-url "<<parameters.slack_webhook_uri>>" \
                --icon-emoji "$icon_emoji"
